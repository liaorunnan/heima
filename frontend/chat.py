import streamlit as st
import time
import random

# è®¾ç½®é¡µé¢é…ç½®
st.set_page_config(page_title="æ™ºèƒ½å®¢æœç³»ç»Ÿ", page_icon="ğŸ¤–")

st.title("ğŸ¤– æ™ºèƒ½å®¢æœ 1.0")
st.caption("æˆ‘æ˜¯æ‚¨çš„AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ")

# -------------------------------------------------------------------------
# 1. æ¨¡æ‹Ÿåç«¯å¤„ç†å‡½æ•° (å®é™…ä½¿ç”¨æ—¶ï¼Œè¿™é‡Œæ›¿æ¢ä¸ºè°ƒç”¨ä½ çš„ API)
# -------------------------------------------------------------------------
def get_backend_response(user_query):
    """
    æ¨¡æ‹Ÿåç«¯å¤„ç†è¿‡ç¨‹ï¼š
    1. æ¥æ”¶ç”¨æˆ·è¾“å…¥
    2. æ¨¡æ‹Ÿè€—æ—¶ (Loading)
    3. è¿”å›ç­”æ¡ˆ
    """
    # æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿæˆ–æ¨¡å‹æ¨ç†æ—¶é—´ (2ç§’)
    time.sleep(2)
    
    # ç®€å•çš„è§„åˆ™å›å¤æ¨¡æ‹Ÿ
    if "ä½ å¥½" in user_query:
        return "æ‚¨å¥½ï¼å¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚è¯·é—®æœ‰ä»€ä¹ˆå…·ä½“é—®é¢˜ï¼Ÿ"
    elif "ä»·æ ¼" in user_query:
        return "æˆ‘ä»¬çš„åŸºç¡€ç‰ˆä»·æ ¼æ˜¯ Â¥99/æœˆï¼Œä¸“ä¸šç‰ˆæ˜¯ Â¥199/æœˆã€‚"
    elif "è®¢å•" in user_query:
        return "è¯·æä¾›æ‚¨çš„è®¢å•å·ï¼Œç¨åä¸ºæ‚¨æŸ¥è¯¢çŠ¶æ€ã€‚"
    else:
        # éšæœºå›å¤ä¸€äº›é€šç”¨è¯æœ¯
        responses = [
            "è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼Œè®©æˆ‘ä¸ºæ‚¨æŸ¥è¯¢ä¸€ä¸‹çŸ¥è¯†åº“ã€‚",
            "æˆ‘æ²¡å¤ªå¬æ‡‚æ‚¨çš„æ„æ€ï¼Œèƒ½å¦æ¢ä¸ªæ–¹å¼æè¿°ï¼Ÿ",
            "è¿™ä¸ªé—®é¢˜æ¶‰åŠåˆ°æŠ€æœ¯ç»†èŠ‚ï¼Œå»ºè®®æŸ¥é˜…æˆ‘ä»¬çš„å®˜æ–¹æ–‡æ¡£ã€‚",
            "åç«¯æ­£åœ¨é£é€Ÿè¿ç®—ä¸­ï¼Œç­”æ¡ˆæ˜¯ï¼š42"
        ]
        return random.choice(responses)

# -------------------------------------------------------------------------
# 2. åˆå§‹åŒ– Session State (ç”¨äºä¿å­˜èŠå¤©å†å²)
# -------------------------------------------------------------------------
if "messages" not in st.session_state:
    st.session_state.messages = [
        {"role": "assistant", "content": "æ‚¨å¥½ï¼æˆ‘æ˜¯æ™ºèƒ½å®¢æœï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨ï¼Ÿ"}
    ]

# -------------------------------------------------------------------------
# 3. æ¸²æŸ“å†å²æ¶ˆæ¯
# -------------------------------------------------------------------------
for msg in st.session_state.messages:
    # st.chat_message æ¥å— "user" æˆ– "assistant"
    with st.chat_message(msg["role"]):
        st.markdown(msg["content"])

# -------------------------------------------------------------------------
# 4. å¤„ç†ç”¨æˆ·è¾“å…¥
# -------------------------------------------------------------------------
# st.chat_input ä¼šåœ¨åº•éƒ¨æ˜¾ç¤ºè¾“å…¥æ¡†
if prompt := st.chat_input("è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..."):
    
    # A. æ˜¾ç¤ºç”¨æˆ·è¾“å…¥
    # 1. å°†ç”¨æˆ·æ¶ˆæ¯åŠ å…¥å†å²è®°å½•
    st.session_state.messages.append({"role": "user", "content": prompt})
    # 2. åœ¨ç•Œé¢ä¸Šå³æ—¶æ˜¾ç¤º
    with st.chat_message("user"):
        st.markdown(prompt)

    # B. æ˜¾ç¤ºæœºå™¨äººçš„å“åº”ï¼ˆå¸¦Loadingæ•ˆæœï¼‰
    with st.chat_message("assistant"):
        # åˆ›å»ºä¸€ä¸ªå ä½ç¬¦ï¼Œç”¨äºæ˜¾ç¤º "Thinking..." æˆ– Spinner
        message_placeholder = st.empty()
        
        # ä½¿ç”¨ st.spinner å±•ç¤ºåŠ è½½çŠ¶æ€ï¼Œç›´åˆ°ä»£ç å—æ‰§è¡Œå®Œæ¯•
        with st.spinner("æ­£åœ¨æŸ¥è¯¢æ•°æ®åº“å¹¶ç”Ÿæˆç­”æ¡ˆ..."):
            # è°ƒç”¨æ¨¡æ‹Ÿçš„åç«¯å‡½æ•°
            response_text = get_backend_response(prompt)
        
        # C. åç«¯è¿”å›åï¼Œæ˜¾ç¤ºæœ€ç»ˆç­”æ¡ˆ
        message_placeholder.markdown(response_text)
    
    # D. å°†æœºå™¨äººå›å¤åŠ å…¥å†å²è®°å½•
    st.session_state.messages.append({"role": "assistant", "content": response_text})