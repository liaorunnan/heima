# 方案 B：将 `tag_mcp(1).py` 改为完全异步

## 需要修改的文件
1. **tag_mcp(1).py** - 主要改造文件
2. **chat_response_api.py** - 更新路由调用
3. **bot_mcp.py** - 添加异步版本的 call_tool

## 详细改造步骤

### 1. 添加异步支持导入
```python
import asyncio
from typing import Any, Dict, List, Optional, Sequence
```

### 2. 修改工具函数为异步
将所有 `@tool` 装饰的函数改为 `async def`：
- `get_chat_history_tool` → `async def get_chat_history_tool`
- `recall_candidate_tags_tool` → `async def recall_candidate_tags_tool`
- `get_user_tags_tool` → `async def get_user_tags_tool`
- `analyze_intent_tool` → `async def analyze_intent_tool`
- `update_user_tags_tool` → `async def update_user_tags_tool`

### 3. 修改 LLM 调用为异步
在 `analyze_customer_intent` 函数中：
- 将 `llm_intent_agent.invoke()` 改为 `llm_intent_agent.ainvoke()`
- 将 `create_agent` 创建的 agent 改为支持异步调用

### 4. 修改数据库操作为异步
- `get_user_tags()` → `async def get_user_tags()`
- `get_user_tags_db()` 需要确认是否支持异步，如果支持则调用异步版本

### 5. 修改 MCP 工具调用为异步
- `call_tool()` → 添加 `async def call_tool_async()`
- 在 `_get_valid_labels()` 和 `_update_customer_labels()` 中使用异步调用

### 6. 修改辅助函数为异步
- `context_licing()` → `async def context_licing()`
- `recall_text()` → `async def recall_text()`
- `filtered_user_tags()` → `async def filtered_user_tags()`
- `_get_valid_labels()` → `async def _get_valid_labels()`
- `_update_customer_labels()` → `async def _update_customer_labels()`
- `analyze_customer_intent()` → `async def analyze_customer_intent()`

### 7. 修改主执行函数为异步
- `run_intent_analysis()` → `async def run_intent_analysis()`
- 使用 `await` 调用所有异步工具函数

### 8. 更新 API 路由
在 `chat_response_api.py` 中：
```python
@router.post("/customer_tagging")
async def customer_tagging(request: TagRequest):
    conversation_id = request.conversation_id
    session_id = request.session_id
    user_id = request.user_id

    result = await run_intent_analysis(
        conversation_id=conversation_id,
        session_id=session_id,
        user_id=user_id
    )

    return result['update_result']
```

## 注意事项

1. **LangChain 异步支持**：LangChain 的 agent 支持 `.ainvoke()` 方法进行异步调用
2. **数据库异步**：需要确认 `get_user_tags_db` 等函数是否支持异步，如果不支持，可能需要使用 `asyncio.to_thread()` 包装
3. **MCP 调用**：`call_tool` 内部已经使用了 `asyncio.run()`，需要改为真正的异步版本
4. **保持逻辑一致**：所有改动只涉及异步化，不修改业务逻辑

## 预期效果
- ✅ 真正的异步执行，充分利用异步 I/O
- ✅ 提升并发性能，减少响应时间
- ✅ 避免阻塞事件循环
- ✅ 保持所有原有业务逻辑不变